# config.py
# Titan SOP V78.3 - Global Configuration (De-duplicated)
# 狀態: 最高法律效力
# [V78.3 Fix]: Cleaned duplicate entries in TITAN_WIDE_POOL and HIGH_PRICED_SEED_POOL.
# This ensures YFinance downloads are efficient and Window 15/16 rankings are accurate.

import os
from pathlib import Path

# ==========================================
# 1. 專案根目錄設定 (Project Root Anchoring)
# ==========================================
# 使用 r"" (raw string) 避免 Windows 路徑的反斜線被誤判為跳脫字元
BASE_DIR = Path(__file__).resolve().parent

# 【自我檢測】: 程式啟動時先檢查路徑是否存在，避免後續連鎖錯誤
if not BASE_DIR.exists():
    raise FileNotFoundError(f"CRITICAL ERROR: 找不到專案根目錄，請檢查路徑: {BASE_DIR}")

# ==========================================
# 2. 資料子目錄映射 (Sub-directory Mapping)
# ==========================================
DATA_DIR = BASE_DIR / "data"            # 放置 .csv, .json 等原始數據
DB_DIR = BASE_DIR / "database"          # 放置 .db 資料庫檔 (若有)
STRATEGY_DIR = BASE_DIR / "strategies"  # 放置策略模組
LOG_DIR = BASE_DIR / "logs"             # 系統日誌

# 自動確保這些資料夾存在 (若無則自動建立，防止報錯)
for _dir in [DATA_DIR, DB_DIR, STRATEGY_DIR, LOG_DIR]:
    _dir.mkdir(parents=True, exist_ok=True)


class Config:
    # --- 1. 神奇均線 ---
    MA_LIFE_LINE = 87
    MA_LONG_TERM = 284
    MA_SHORT_TERM = 43
    MA_SLOPE_20D = 20
    MA_SLOPE_60D = 60

    # --- 2. 策略濾網 ---
    FILTER_MAX_PRICE = 115.0 # 四大天條之一：價格濾網

    # --- 3. 價格區間 (SOP核心) ---
    SWEET_SPOT_LOW = 106
    SWEET_SPOT_HIGH = 110
    CB_PAR_VALUE = 100

    EXIT_TARGET_MEDIAN = 152

    # --- 4. 宏觀監控 ---
    TICKER_TSE = "^TWII"     # 台灣加權指數
    TICKER_VIX = "^VIX"

    # PTT 空頭比例計算用的高價種子池 (V78.3 優化版 - 去重)
    # 基於台股前100高價股，作為市場多空溫度計的真實樣本
    _raw_high_pool = [
        "5274.TW", "6669.TW", "3661.TW", "3008.TW", "3443.TW", "2059.TW", "3653.TW",
        "8299.TW", "6515.TW", "3529.TW", "6415.TW", "1590.TW", "2308.TW", "6409.TW",
        "6643.TW", "3533.TW", "6461.TW", "6799.TW", "6223.TW", "3481.TW", "8454.TW",
        "6531.TW", "6472.TW", "3131.TW", "6680.TW", "6869.TW", "4966.TW", "3037.TW",
        "6756.TW", "6187.TW", "6510.TW", "6719.TW", "3680.TW", "8069.TW", "6446.TW",
        "2379.TW", "3711.TW", "2330.TW", "5269.TW", "6271.TW", "3035.TW", "4935.TW",
        "3406.TW", "6196.TW", "2454.TW", "6121.TW", "6239.TW", "6278.TW", "8081.TW",
        "3693.TW", "6488.TW", "2382.TW", "3231.TW", "4919.TW", "3583.TW", "2376.TW",
        "2377.TW", "2395.TW", "2408.TW", "2458.TW", "2618.TW", "2881.TW", "2882.TW",
        "2886.TW", "2891.TW", "2892.TW", "2912.TW", "3045.TW", "3376.TW", "3702.TW",
        "4904.TW", "5871.TW", "5880.TW", "6005.TW", "6505.TW", "9910.TW", "1301.TW",
        "1303.TW", "2002.TW", "1101.TW", "1216.TW", "2207.TW", "2603.TW", "2609.TW",
        "2615.TW", "8464.TW", "9904.TW", "9921.TW", "9933.TW", "9938.TW", "9945.TW",
        "1795.TW", "6442.TW", "4743.TW", "4128.TW", "4162.TW", "4147.TW", "6491.TW",
        "6547.TW", "6684.TW", "6782.TW", "8436.TW", "8406.TW", "1560.TW", "1519.TW",
        "1503.TW", "1513.TW", "1514.TW"
    ]
    HIGH_PRICED_SEED_POOL = sorted(list(set(_raw_high_pool)))

    # [V78.3 NEW] Window 16 動態成交重心掃描用的戰略股票池
    # 涵蓋台灣50、中型100、富櫃50、高價股、AI供應鏈、CoWoS、重電綠能、生技、IP設計、散熱、機器人等，共約400檔
    _raw_wide_pool = [
        # --- 台灣50 + 核心權值 (部分重疊) ---
        "2330.TW", "2454.TW", "2317.TW", "2308.TW", "3008.TW", "6505.TW", "2881.TW",
        "2882.TW", "2886.TW", "1301.TW", "1303.TW", "2002.TW", "1216.TW", "1101.TW",
        "2382.TW", "3034.TW", "3037.TW", "4904.TW", "2327.TW", "2412.TW", "3711.TW",
        "2891.TW", "2884.TW", "2885.TW", "5880.TW", "2892.TW", "2303.TW", "2379.TW",
        "2395.TW", "2880.TW", "2883.TW", "2887.TW", "5871.TW", "5876.TW", "2357.TW",
        "3231.TW", "4938.TW", "2345.TW", "2408.TW", "2474.TW", "2801.TW", "2912.TW",
        "3045.TW", "9910.TW", "2409.TW", "2451.TW", "2207.TW", "2603.TW", "2609.TW",
        "2615.TW", "1326.TW", "1402.TW", "2888.TW", "2890.TW", "6669.TW",

        # --- 上市櫃高價股 (股價 > 200) ---
        "3661.TW", "5274.TW", "6415.TW", "3529.TW", "3443.TW", "8454.TW", "1590.TW",
        "2059.TW", "8299.TW", "3533.TW", "6409.TW", "3563.TW", "8046.TW", "3611.TW",
        "8464.TW", "6271.TW", "3035.TW", "4966.TW", "6515.TW", "3653.TW", "6223.TW",
        "6461.TW", "6799.TW", "3481.TW", "6531.TW", "6472.TW", "3131.TW", "6680.TW",
        "6869.TW", "6756.TW", "6187.TW", "6510.TW", "6719.TW", "3680.TW", "8069.TW",
        "6446.TW", "5269.TW", "4935.TW", "3406.TW", "6196.TW", "6121.TW", "6239.TW",
        "6278.TW", "8081.TW", "3693.TW", "6488.TW", "3583.TW", "2376.TW", "2377.TW",
        "3376.TW", "3702.TW", "6005.TW", "1795.TW", "6442.TW", "4743.TW", "4128.TW",
        "4162.TW", "4147.TW", "6491.TW", "6547.TW", "6684.TW", "6782.TW", "8436.TW",
        "8406.TW", "1560.TW", "1519.TW", "1503.TW", "1513.TW", "1514.TW", "3675.TW",
        "4919.TW", "8064.TW", "8437.TW", "6695.TW", "6805.TW", "3105.TW", "5289.TW",

        # --- AI 伺服器供應鏈 & CoWoS 概念股 ---
        "2382.TW", "3231.TW", "6669.TW", "2356.TW", "2317.TW", "2376.TW", "3706.TW",
        "8210.TW", "3693.TW", "6117.TW", "3013.TW", "2421.TW", "6196.TW", "6187.TW",
        "3583.TW", "2449.TW", "3374.TW", "3680.TW", "6533.TW", "3037.TW", "3711.TW",
        "2316.TW", "1560.TW", "6285.TW", "3527.TW", "6640.TW", "6706.TW", "6139.TW",
        "3413.TW", "3536.TW", "6261.TW", "8028.TW", "3169.TW", "6271.TW", "3653.TW",
        "3017.TW", "6230.TW", "3324.TW", "3017.TW", "2467.TW", "6664.TW", "6789.TW",

        # --- 重電 & 綠能概念股 ---
        "1519.TW", "1503.TW", "1513.TW", "1514.TW", "1605.TW", "1609.TW", "1618.TW",
        "2371.TW", "6806.TW", "8996.TW", "1589.TW", "3023.TW", "6473.TW", "9958.TW",
        "3708.TW", "6449.TW", "6244.TW", "4934.TW", "6411.TW", "6482.TW", "6861.TW",

        # --- 生技新藥 & 醫療器材 ---
        "6446.TW", "1795.TW", "6472.TW", "4128.TW", "4142.TW", "4162.TW", "4147.TW",
        "6547.TW", "4108.TW", "4114.TW", "4133.TW", "6612.TW", "6692.TW", "6875.TW",
        "1760.TW", "1789.TW", "1784.TW", "4107.TW", "4192.TW", "6465.TW", "6523.TW",
        "6589.TW", "6657.TW", "6949.TW", "8279.TW", "4728.TW", "4735.TW", "4743.TW",

        # --- IP 設計 & ASIC ---
        "3661.TW", "3443.TW", "3529.TW", "6533.TW", "3035.TW", "6643.TW", "6531.TW",
        "6695.TW", "3443.TW", "6590.TW", "6742.TW", "3228.TW", "6684.TW", "6859.TW",

        # --- 散熱族群 ---
        "3017.TW", "3324.TW", "3653.TW", "6125.TW", "8210.TW", "3693.TW", "6230.TW",
        "2421.TW", "3484.TW", "8996.TW", "1587.TW", "3162.TW", "3013.TW", "6197.TW",
        "2233.TW", "4566.TW", "4551.TW", "2228.TW",

        # --- 機器人概念股 ---
        "2049.TW", "1590.TW", "1597.TW", "2308.TW", "6414.TW", "2359.TW", "8033.TW",
        "2464.TW", "6166.TW", "4540.TW", "4562.TW", "8374.TW", "7750.TW", "1504.TW",
        "1583.TW", "2360.TW", "5443.TW", "6215.TW",

        # --- 中型100 + 富櫃50 + 其他熱門股 (補遺) ---
        "2610.TW", "2618.TW", "6548.TW", "1503.TW", "1536.TW", "1560.TW", "1722.TW",
        "1723.TW", "1773.TW", "1785.TW", "1802.TW", "2006.TW", "2014.TW", "2027.TW",
        "2105.TW", "2201.TW", "2204.TW", "2206.TW", "2313.TW", "2324.TW", "2337.TW",
        "2344.TW", "2352.TW", "2353.TW", "2354.TW", "2356.TW", "2368.TW", "2371.TW",
        "2383.TW", "2404.TW", "2439.TW", "2449.TW", "2458.TW", "2464.TW", "2485.TW",
        "2492.TW", "2498.TW", "2501.TW", "2542.TW", "2601.TW", "2606.TW", "2634.TW",
        "2637.TW", "2823.TW", "2834.TW", "2855.TW", "3005.TW", "3023.TW", "3044.TW",
        "3189.TW", "3450.TW", "3596.TW", "3682.TW", "3706.TW", "4763.TW", "4915.TW",
        "4958.TW", "5347.TW", "5434.TW", "5483.TW", "5522.TW", "6176.TW", "6191.TW",
        "6202.TW", "6213.TW", "6269.TW", "6285.TW", "6414.TW", "6456.TW", "6526.TW",
        "6643.TW", "6770.TW", "8016.TW", "8105.TW", "8150.TW", "8210.TW", "8261.TW",
        "9917.TW", "9945.TW", "4114.TW", "5289.TW", "6146.TW", "6182.TW", "8044.TW",
        "8086.TW", "3293.TW", "3587.TW", "4979.TW", "5278.TW", "5315.TW", "5425.TW",
        "5457.TW", "5481.TW", "6104.TW", "6163.TW", "6188.TW", "6220.TW", "6279.TW",
        "8050.TW", "8091.TW", "8358.TW", "8933.TW"
    ]
    TITAN_WIDE_POOL = sorted(list(set(_raw_wide_pool)))

    PRICE_COL_KEYWORDS = [
        '可轉債市價', '收盤價', 'close', '現價', '成交', 'price',
        '買進', '賣出', '成交價', '市價', 'last'
    ]
    
    # --- 5. 時間與風控 ---
    LISTING_HONEYMOON_DAYS = 90
    LISTING_DORMANT_DAYS = 365
    PUT_AVOID_TAX_DAYS = 180

    EVENT_SHORT_COVER_MONTHS = [3, 4]
    EVENT_DIVIDEND_MONTHS = [6, 8]

    PR90_OVERHEAT = 130
    PR75_OPPORTUNITY = 105
    VIX_PANIC = 25

    # --- 6. 發債故事關鍵字 ---
    STORY_KEYWORDS = ["AI", "綠能", "軍工", "重電", "擴產", "政策", "從無到有", "新廠", "併購", "轉機"]